name: BGM Auto Upload (Fixed)

on:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  run:
    runs-on: ubuntu-latest
    timeout-minutes: 180

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Restore YouTube OAuth files
        shell: bash
        env:
          YT_TOKEN_JSON_B64: ${{ secrets.YT_TOKEN_JSON_B64 }}
          YT_CLIENT_SECRET_B64: ${{ secrets.YT_CLIENT_SECRET_B64 }}
        run: |
          set -euo pipefail
          mkdir -p .yt_token

          python3 - <<'PY'
import os, base64, json, pathlib, sys

def decode_env(var: str, out_path: str):
    b = os.environ.get(var, "")
    if not b.strip():
        print(f"[ERROR] secret {var} is empty", file=sys.stderr)
        sys.exit(1)

    # remove whitespaces/newlines and fix padding
    b = "".join(b.split())
    b += "=" * (-len(b) % 4)

    data = base64.b64decode(b)
    p = pathlib.Path(out_path)
    p.parent.mkdir(parents=True, exist_ok=True)
    p.write_bytes(data)

    # JSON check
    json.loads(p.read_text(encoding="utf-8"))
    print("[OK] wrote", p)

decode_env("YT_TOKEN_JSON_B64", ".yt_token/token.json")
decode_env("YT_CLIENT_SECRET_B64", "client_secret.json")
PY

          ls -la .yt_token
          ls -la client_secret.json

      - name: Download bgms.zip from latest Release
        shell: bash
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y jq unzip

          mkdir -p _assets

          api="https://api.github.com/repos/${GITHUB_REPOSITORY}/releases/latest"
          rel_json="$(curl -sL -H "Authorization: Bearer ${GH_TOKEN}" -H "Accept: application/vnd.github+json" "$api")"

          asset_url="$(echo "$rel_json" | jq -r '.assets[] | select(.name=="bgms.zip") | .url')"
          if [ -z "$asset_url" ] || [ "$asset_url" = "null" ]; then
            echo "[ERROR] bgms.zip not found in latest release assets" >&2
            echo "[INFO] available assets:" >&2
            echo "$rel_json" | jq -r '.assets[].name' >&2 || true
            exit 1
          fi

          echo "[INFO] Downloading bgms.zip ..."
          curl -L \
            -H "Authorization: Bearer ${GH_TOKEN}" \
            -H "Accept: application/octet-stream" \
            "$asset_url" \
            -o _assets/bgms.zip

          ls -lh _assets/bgms.zip

          rm -rf bgms bgms_unpack
          mkdir -p bgms_unpack
          unzip -q _assets/bgms.zip -d bgms_unpack

          if [ -d bgms_unpack/bgms ]; then
            mv bgms_unpack/bgms bgms
          else
            mv bgms_unpack bgms
          fi

          echo "[INFO] audio file count in ./bgms:"
          find bgms -type f \( -iname "*.mp3" -o -iname "*.wav" -o -iname "*.m4a" -o -iname "*.aac" -o -iname "*.flac" -o -iname "*.ogg" \) | wc -l

      - name: Install dependencies
        shell: bash
        run: |
          python -m pip install --upgrade pip
          python -m pip install \
            pillow \
            google-api-python-client \
            google-auth \
            google-auth-oauthlib \
            google-auth-httplib2

      - name: Install ffmpeg
        shell: bash
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg
          ffmpeg -version
          ffprobe -version

      - name: Sanity check inputs
        shell: bash
        run: |
          set -euo pipefail
          echo "[INFO] image files in ./images = $(find images -type f | wc -l)"
          echo "[INFO] audio files in ./bgms  = $(find bgms -type f | wc -l)"
          test -d images
          test -d bgms

      - name: Run pipeline (generate + upload)
        shell: bash
        env:
          TZ: Asia/Tokyo
        run: |
          set -euo pipefail

          # existing fonts on ubuntu-latest
          FONT="/usr/share/fonts/truetype/dejavu/DejaVuSans.ttf"
          FONT_BOLD="/usr/share/fonts/truetype/dejavu/DejaVuSans-Bold.ttf"

          python3 run_bgm_pipeline.py \
            --client_secrets ./client_secret.json \
            --token ./.yt_token/token.json \
            --privacy public \
            --out_dir ./output \
            --bgm_dir ./bgms \
            --img_dir ./images \
            --thumb_text \
            --thumb_text_candidates_file ./thumbnail_text_candidates.txt \
            --thumb_text_fontfile "$FONT_BOLD" \
            --make_video \
            --clock \
            --clock_fontfile "$FONT"
