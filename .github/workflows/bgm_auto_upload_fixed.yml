name: BGM Auto Upload (fixed)

on:
  workflow_dispatch:
  schedule:
    # JST 10:00 = UTC 01:00
    - cron: "0 1 * * *"

concurrency:
  group: bgm-auto-upload
  cancel-in-progress: false

jobs:
  run:
    runs-on: ubuntu-latest
    timeout-minutes: 180

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Optional: free disk space (helps avoid "No space left on device")
      - name: Free disk space (optional)
        shell: bash
        run: |
          set -euo pipefail
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc || true
          df -h

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Restore YouTube OAuth files
        shell: bash
        env:
          YT_TOKEN_JSON_B64: ${{ secrets.YT_TOKEN_JSON_B64 }}
          YT_CLIENT_SECRET_B64: ${{ secrets.YT_CLIENT_SECRET_B64 }}
        run: |
          set -euo pipefail

          python3 - <<'PY'
          import os, base64, json, pathlib, sys

          def decode_env(env: str, out_path: str):
              b64 = os.environ.get(env, "")
              if not b64.strip():
                  print(f"[ERROR] secret {env} is empty", file=sys.stderr)
                  sys.exit(1)

              # remove whitespace/newlines + fix padding
              b64 = "".join(b64.split())
              b64 += "=" * (-len(b64) % 4)

              data = base64.b64decode(b64)
              p = pathlib.Path(out_path)
              p.parent.mkdir(parents=True, exist_ok=True)
              p.write_bytes(data)

              # JSON validity check
              json.loads(p.read_text(encoding="utf-8"))
              print("[OK] wrote", p)

          decode_env("YT_TOKEN_JSON_B64", ".yt_token/token.json")
          decode_env("YT_CLIENT_SECRET_B64", "client_secret.json")
          PY

          ls -la .yt_token
          ls -la client_secret.json

      - name: Install dependencies
        shell: bash
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          python -m pip install \
            pillow \
            google-api-python-client \
            google-auth \
            google-auth-oauthlib \
            google-auth-httplib2

      - name: Install ffmpeg + unzip
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y ffmpeg unzip
          ffmpeg -version
          ffprobe -version

      - name: Download & extract bgms.zip from latest Release
        shell: bash
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail

          rm -rf bgms bgms.zip .tmp_bgms

          # download bgms.zip from latest Release
          gh release download --repo "$GITHUB_REPOSITORY" --pattern "bgms.zip" --clobber
          ls -lh bgms.zip

          mkdir -p .tmp_bgms
          unzip -q bgms.zip -d .tmp_bgms

          # handle both: zip contains "bgms/" or directly audio files
          if [ -d .tmp_bgms/bgms ]; then
            mv .tmp_bgms/bgms bgms
          else
            mkdir -p bgms
            shopt -s dotglob
            mv .tmp_bgms/* bgms/
          fi

          rm -rf .tmp_bgms bgms.zip

          AUDIO_COUNT=$(find bgms -type f \( -iname '*.mp3' -o -iname '*.wav' -o -iname '*.m4a' -o -iname '*.aac' -o -iname '*.flac' -o -iname '*.ogg' \) | wc -l)
          echo "[INFO] audio files in ./bgms = ${AUDIO_COUNT}"
          test "${AUDIO_COUNT}" -gt 0

      - name: Sanity check images
        shell: bash
        run: |
          set -euo pipefail
          IMG_COUNT=$(find images -type f \( -iname '*.jpg' -o -iname '*.jpeg' -o -iname '*.png' -o -iname '*.webp' \) | wc -l)
          echo "[INFO] image files in ./images = ${IMG_COUNT}"
          test "${IMG_COUNT}" -gt 0

      - name: Run pipeline (generate + upload)
        shell: bash
        env:
          TZ: Asia/Tokyo
        run: |
          set -euo pipefail

          # unique seed per run (prevents same-day rerun from generating same video)
          SEED="${GITHUB_RUN_ID}"
          echo "[INFO] SEED=${SEED}"

          FONT="/usr/share/fonts/truetype/dejavu/DejaVuSans.ttf"
          FONT_BOLD="/usr/share/fonts/truetype/dejavu/DejaVuSans-Bold.ttf"

          python3 run_bgm_pipeline.py \
            --client_secrets ./client_secret.json \
            --token ./.yt_token/token.json \
            --privacy public \
            --out_dir ./output \
            --seed "${SEED}" \
            --bgm_dir ./bgms \
            --img_dir ./images \
            --thumb_text \
            --thumb_text_candidates_file ./thumbnail_text_candidates.txt \
            --thumb_text_fontfile "$FONT_BOLD" \
            --make_video \
            --clock \
            --clock_fontfile "$FONT"

      - name: Cleanup (optional)
        if: always()
        shell: bash
        run: |
          rm -rf output/_work || true
          rm -rf bgms || true
          df -h || true
