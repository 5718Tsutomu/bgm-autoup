name: BGM Auto Upload (fixed)

on:
  workflow_dispatch:

jobs:
  run:
    runs-on: ubuntu-latest
    timeout-minutes: 120

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # Secrets から token/client_secret を復元（padding/改行崩れに強い）
      - name: Restore YouTube OAuth files
        shell: bash
        env:
          YT_TOKEN_JSON_B64: ${{ secrets.YT_TOKEN_JSON_B64 }}
          YT_CLIENT_SECRET_B64: ${{ secrets.YT_CLIENT_SECRET_B64 }}
        run: |
          set -euo pipefail
          python3 - <<'PY'
          import os, base64, json, pathlib, sys

          def decode_env_to_file(env_name: str, out_path: str):
              b64 = os.environ.get(env_name, "")
              if not b64.strip():
                  print(f"[ERROR] Missing secret: {env_name}", file=sys.stderr)
                  sys.exit(1)

              # remove whitespace/newlines
              b64 = "".join(b64.split())
              # add padding if needed
              b64 += "=" * ((-len(b64)) % 4)

              try:
                  data = base64.b64decode(b64, validate=False)
              except Exception as e:
                  print(f"[ERROR] base64 decode failed for {env_name}: {e}", file=sys.stderr)
                  sys.exit(1)

              p = pathlib.Path(out_path)
              p.parent.mkdir(parents=True, exist_ok=True)
              p.write_bytes(data)

              # JSON validation
              json.loads(p.read_text(encoding="utf-8"))
              print("[OK] wrote", p)

          decode_env_to_file("YT_TOKEN_JSON_B64", ".yt_token/token.json")
          decode_env_to_file("YT_CLIENT_SECRET_B64", "client_secret.json")
          PY

          ls -la .yt_token
          ls -la client_secret.json

      - name: Install dependencies
        shell: bash
        run: |
          python -m pip install --upgrade pip
          python -m pip install \
            pillow \
            google-api-python-client \
            google-auth \
            google-auth-oauthlib \
            google-auth-httplib2

      - name: Install ffmpeg + unzip
        shell: bash
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg unzip
          ffmpeg -version
          unzip -v | head -n 2

      # Releases に置いた bgms.zip を落として展開して ./bgms を作る
      - name: Download bgms.zip from latest Release
        shell: bash
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail

          # gh は ubuntu-latest に基本入ってます
          gh --version

          rm -f bgms.zip
          rm -rf bgms _bgms_unzip

          gh release download --pattern "bgms.zip" --clobber --repo "$GITHUB_REPOSITORY"

          test -f bgms.zip
          mkdir -p _bgms_unzip
          unzip -q bgms.zip -d _bgms_unzip

          # zipの中が bgms/ で入ってる場合と、直下にファイルが入ってる場合の両対応
          if [ -d "_bgms_unzip/bgms" ]; then
            mv "_bgms_unzip/bgms" "./bgms"
          else
            mkdir -p bgms
            mv _bgms_unzip/* bgms/ || true
          fi

          echo "[INFO] bgms dir:"
          ls -la bgms | head -n 50

      - name: Sanity check inputs
        shell: bash
        run: |
          set -euo pipefail

          IMG_COUNT="$(find images -type f 2>/dev/null | wc -l | tr -d ' ')"
          AUDIO_COUNT="$(find bgms -type f \( -iname "*.mp3" -o -iname "*.wav" -o -iname "*.m4a" -o -iname "*.aac" -o -iname "*.flac" -o -iname "*.ogg" \) 2>/dev/null | wc -l | tr -d ' ')"

          echo "[INFO] image files in ./images = ${IMG_COUNT}"
          echo "[INFO] audio files in ./bgms  = ${AUDIO_COUNT}"

          test -d images
          test -d bgms
          test "${IMG_COUNT}" -gt 0
          test "${AUDIO_COUNT}" -gt 0

      - name: Run pipeline (generate + upload)
        shell: bash
        env:
          TZ: Asia/Tokyo
        run: |
          set -euo pipefail

          FONT="/usr/share/fonts/truetype/dejavu/DejaVuSans.ttf"
          FONT_BOLD="/usr/share/fonts/truetype/dejavu/DejaVuSans-Bold.ttf"

          python3 run_bgm_pipeline.py \
            --client_secrets ./client_secret.json \
            --token ./.yt_token/token.json \
            --privacy public \
            --out_dir ./output \
            --bgm_dir ./bgms \
            --img_dir ./images \
            --thumb_text \
            --thumb_text_candidates_file ./thumbnail_text_candidates.txt \
            --thumb_text_fontfile "$FONT_BOLD" \
            --make_video \
            --clock \
            --clock_fontfile "$FONT"
