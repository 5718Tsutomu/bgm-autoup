name: BGM Auto Upload (fixed)

on:
  workflow_dispatch:
    inputs:
      upload:
        description: "Upload to YouTube? (true/false). Scheduled runs always upload."
        required: true
        default: "false"
  schedule:
    # 10:00 JST = 01:00 UTC
    - cron: "0 1 * * *"

permissions:
  contents: read

jobs:
  bgm:
    runs-on: ubuntu-latest
    env:
      TZ: Asia/Tokyo
      DO_UPLOAD: ${{ github.event_name == 'schedule' || inputs.upload == 'true' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        shell: bash
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          python -m pip install \
            pillow \
            google-api-python-client \
            google-auth \
            google-auth-oauthlib \
            google-auth-httplib2

      - name: Install ffmpeg + unzip
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y ffmpeg unzip
          ffmpeg -version

      - name: Restore YouTube OAuth files from Secrets
        shell: bash
        env:
          YT_TOKEN_JSON_B64: ${{ secrets.YT_TOKEN_JSON_B64 }}
          YT_CLIENT_SECRET_B64: ${{ secrets.YT_CLIENT_SECRET_B64 }}
        run: |
          set -euo pipefail
          python3 - <<'PY'
          import os, base64, json, pathlib

          def decode_env_to_file(env_name: str, out_path: str):
              b64 = os.environ.get(env_name, "")
              if not b64.strip():
                  raise SystemExit(f"Missing secret: {env_name}")
              b64 = "".join(b64.split())
              b64 += "=" * ((-len(b64)) % 4)
              data = base64.b64decode(b64)
              p = pathlib.Path(out_path)
              p.parent.mkdir(parents=True, exist_ok=True)
              p.write_bytes(data)
              json.loads(p.read_text(encoding="utf-8"))
              print("[OK] wrote", p)

          decode_env_to_file("YT_TOKEN_JSON_B64", ".yt_token/token.json")
          decode_env_to_file("YT_CLIENT_SECRET_B64", "client_secret.json")
          PY

      - name: Download bgms.zip from latest Release and extract
        shell: bash
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          rm -rf bgms _bgms_zip bgms.zip

          gh version
          gh release download --repo "$GITHUB_REPOSITORY" --pattern "bgms.zip" --dir .

          mkdir -p _bgms_zip
          unzip -q bgms.zip -d _bgms_zip

          if [ -d "_bgms_zip/bgms" ]; then
            mv _bgms_zip/bgms bgms
            rm -rf _bgms_zip
          else
            mv _bgms_zip bgms
          fi

          rm -f bgms.zip

          test -d bgms
          echo "[INFO] audio files in ./bgms = $(find bgms -type f \( -iname '*.mp3' -o -iname '*.wav' -o -iname '*.m4a' -o -iname '*.aac' -o -iname '*.flac' -o -iname '*.ogg' \) | wc -l)"
          du -sh bgms || true

      - name: Sanity check inputs
        shell: bash
        run: |
          set -euo pipefail
          test -d images
          test -d bgms
          echo "[INFO] image files in ./images = $(find images -type f | wc -l)"

      - name: Compute SEED (different every run)
        shell: bash
        run: |
          set -euo pipefail
          SEED=$(( $(date +%s) + ${GITHUB_RUN_ID} + ${GITHUB_RUN_ATTEMPT} ))
          echo "SEED=$SEED" >> "$GITHUB_ENV"
          echo "[INFO] SEED=$SEED"

      - name: Generate package (audio + thumbnail + video)
        shell: bash
        run: |
          set -euo pipefail

          FONT="/usr/share/fonts/truetype/dejavu/DejaVuSans.ttf"
          FONT_BOLD="/usr/share/fonts/truetype/dejavu/DejaVuSans-Bold.ttf"

          python3 generate_bgm_package.py \
            --out_dir ./output \
            --bgm_dir ./bgms \
            --img_dir ./images \
            --seed "$SEED" \
            --thumb_text \
            --thumb_text_candidates_file ./thumbnail_text_candidates.txt \
            --thumb_text_fontfile "$FONT_BOLD" \
            --make_video \
            --clock \
            --clock_fontfile "$FONT"

          rm -rf ./output/_work || true

      - name: Upload to YouTube (scheduled runs only by default)
        if: env.DO_UPLOAD == 'true'
        shell: bash
        run: |
          set -euo pipefail
          python3 upload_youtube.py \
            --client_secrets ./client_secret.json \
            --token ./.yt_token/token.json \
            --video ./output/video.mp4 \
            --thumb ./output/thumbnail.jpg \
            --title_file ./output/title.txt \
            --description_file ./output/description.txt \
            --privacy public \
            --category_id 10
